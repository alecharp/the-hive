<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>The Hive</title>

  <link rel="stylesheet" type="text/css"
        href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
        integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
        crossorigin=""/>
  <link rel="stylesheet" type="text/css"
        href="https://unpkg.com/semantic-ui@2.2.12/dist/semantic.min.css"
        crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
          integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
          crossorigin=""></script>
  <script src="https://unpkg.com/jquery@3.2.1/dist/jquery.min.js"
          crossorigin=""></script>
  <script src="https://unpkg.com/semantic-ui@2.2.12/dist/semantic.min.js"
          crossorigin=""></script>

  <style rel="stylesheet" media="screen">
    body {
      padding: 0;
      margin: 0;
    }
    div#content {
      height: 100vh;
      width: 100vw;
    }

    button#create-bee {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 900;
    }
  </style>
</head>
<body>

<div id="content">
  <button id="create-bee" class="ui button huge icon red circular" onclick="$('.modal').modal('show')">
    <i class="add circle icon"></i>
  </button>
</div>

<div class="ui modal tiny">
  <div class="header">Create new entry</div>
  <div class="content">
    <form class="ui form" action="#">
      <div class="field required">
        <label>Name</label>
        <input placeholder="Name" name="name">
      </div>
      <div class="field required">
        <label>Email</label>
        <input type="email" placeholder="Email" name="email">
      </div>
      <div class="field required">
        <label>Location</label>
        <div class="three fields">
          <div class="field two wide">
            <button class="ui icon button" id="location">
              <i class="icon location arrow"></i>
            </button>
          </div>
          <div class="field seven wide">
            <input type="number" name="latitude" placeholder="Latitude">
          </div>
          <div class="field seven wide">
            <input type="number" name="longitude" placeholder="Longitude">
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="actions">
    <div class="ui buttons">
      <button class="ui button red cancel">Cancel</button>
      <div class="or"></div>
      <button class="ui positive button" onclick="$('.ui.form').form('validate form')">Save</button>
    </div>
  </div>
</div>

<script type="application/javascript">
  (function() {
    const hive = L.map('content').setView([48.85, 2.35], 3);
    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 7,
      minZoom: 3,
      attribution: '&copy;&nspar;<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      continuousWorld: true
    }).addTo(hive);

    $('.ui.modal').modal({
      onApprove: function () {
        return false;
      },
      onDeny: function () {
        $('.ui.form').form('reset');
      }
    });

    /**
     * Define the acceptable boundaries of a number input.
     *
     * Syntax is minValue:maxValue.
     */
    $.fn.form.settings.rules.boundaries = function (value, boundaries) {
      const [minValue, maxValue] = boundaries.split(':');
      return Number(value) >= Number(minValue) && Number(value) <= Number(maxValue);
    };

    $('.ui.form').form({
      inline: true,
      onSuccess: function (e, fields) {
        if (e !== undefined) e.preventDefault();
        $('.ui.form').addClass('loading');

        $.ajax({
          type: 'POST',
          url: '/api/bee',
          data: JSON.stringify(fields),
          contentType: 'application/json'
        })
          .done(function () {
            $('.ui.form').form('reset');
            $('.ui.modal').modal('hide')
          })
          .fail(function () {
            $('.ui.form').form('set error');
          })
          .always(function () {
            $('.ui.form').removeClass('loading')
          });
      },
      fields: {
        name: {
          rules: [{
            type: 'empty',
            prompt: 'You must specify your name'
          }]
        },
        email: {
          rules: [{
            type: 'empty',
            prompt: 'You must specify your email'
          }, {
            type: 'email',
            prompt: 'Specified email is not valid'
          }]
        },
        latitude: {
          rules: [{
            type: 'empty',
            prompt: 'You must specify the latitude of your location'
          }, {
            type: 'number',
            prompt: 'The latitude must be a decimal number'
          }, {
            type: 'boundaries[-90:90]',
            prompt: 'The latitude must be higher than -90 and less than 90'
          }]
        },
        longitude: {
          rules: [{
            type: 'empty',
            prompt: 'You must specify the longitude of your location'
          }, {
            type: 'number',
            prompt: 'The longitude must be a decimal number'
          }, {
            type: 'boundaries[-180:180]',
            prompt: 'The latitude must be higher than -180 and less than 180'
          }]
        }
      }
    });

    const locationButton = $('.ui.button#location');
    if(!("geolocation" in navigator)) {
      locationButton.toggleClass('disabled');
    }

    locationButton.click(function(event) {
      event.preventDefault();
      locationButton.toggleClass('loading');
      navigator.geolocation.getCurrentPosition(function(position) {
        $('.ui.form').form('set values', {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        });
        locationButton.toggleClass('loading');
      }, function () {
        locationButton.toggleClass('loading');
        locationButton.toggleClass('disabled');
      })
    });
  })();
</script>

</body>
</html>